---
title: "NFL Play-by-Play Exploratory Data Analysis (2009-2018)"
author: "Your Name"
format: 
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    theme: cosmo
    embed-resources: true
editor: visual
---

# Introduction

This document contains exploratory data analysis (EDA) for NFL play-by-play data from 2009-2018. The goal is to understand the structure of the data and identify interesting patterns that will inform the development of an interactive Shiny application.

# Setup and Data Loading

```{r setup, message=FALSE, warning=FALSE}
# Load required packages
library(tidyverse)
library(knitr)

# Set theme for all plots
theme_set(theme_minimal(base_size = 12))
```

```{r load-data, message=FALSE}
# Read in the NFL play-by-play data
nfl_09_18 <- read_csv("NFL Play by Play 2009-2018 (v5).csv")

# Display dimensions
cat("Dataset contains", nrow(nfl_09_18), "rows and", ncol(nfl_09_18), "columns\n")
```

# Data Structure and Validation

## Column Names

List the names to see what could be interesting to explore:

```{r column-names}
# Display all column names
colnames(nfl_09_18)
```

## Data Structure

EDA step: Understand how the data is stored.

```{r data-structure}
# Examine structure of key variables
str(nfl_09_18)
```

## Basic Data Validation

Check that the mins/max etc all make sense:

```{r data-validation, eval=FALSE}
psych::describe(nfl_09_18)
```

## Missing Values Analysis

Determine the rate of missing values:

```{r missing-values}
# Calculate missing value counts
missing_counts <- colSums(is.na(nfl_09_18))
missing_counts
```

## Data Preparation

Adding season column so we can explore each team over the seasons:

```{r data-prep}
# Add season variable
nfl_09_18 <- nfl_09_18 |>
  mutate(season = year(game_date))

# Create a clean subset for main analysis (pass and run plays only)
nfl_small <- nfl_09_18 |>
  filter(
    play_type %in% c("run", "pass"),
    !is.na(down),
    down <= 4
  )

cat("Filtered dataset contains", nrow(nfl_small), "plays (pass and run only)\n")
```

# Categorical Data Analysis

## One-Way Contingency Tables

### Play Type Distribution

Create a one-way contingency table investigating the frequency of the categorical variable play type:

```{r one-way-play-type}
# One-way table for play type
play_type <- table(nfl_09_18$play_type)
play_type
```

**Observation:** Notice from above that most plays are either a run or pass. Special teams plays (punt, field goal, kickoff) occur much less frequently.

## Two-Way Contingency Tables

### Play Type by Down

Now I want to look at type of play by the down - this is a two-way contingency table:

```{r two-way-type-down}
# Two-way table: play type by down
type_by_down <- table(nfl_09_18$play_type, nfl_09_18$down)
type_by_down
```

**Key Findings:**

As expected when we look at the table above we can see that most of the field goal attempts happen in the 4th down. We also expect that most punts happen in the 4th down which is shown here with only 2 occasions deviating from that expectation over 9 seasons.

It is interesting to me that the number of runs decrease as the down increases, yet passing remains fairly evenly spread (with the exception of the 4th down for both passing and running).

# Numerical Summaries

## Yards Gained by Play Type

Next I am exploring the average yards gained for running vs passing play type:

```{r numeric-summary-yards}
# Average yards gained for runs vs passes
nfl_small |>
  group_by(play_type) |>
  summarise(
    n = n(),
    mean_yards = mean(yards_gained, na.rm = TRUE),
    median_yards = median(yards_gained, na.rm = TRUE),
    sd_yards = sd(yards_gained, na.rm = TRUE)
  )
```

**Interpretation:** Looking at the summaries above, it is interesting to see that the average yards gained for passing is higher than for running. However, the SD for running the ball is much smaller, suggesting it is much more stable. Both of the medians are close although passing beats running by one yard. This indicates that while passing can yield higher gains on average, running provides more consistent, predictable yardage.

## Yards Gained by Down and Play Type

```{r numeric-summary-down-playtype}
# Summary statistics for yards gained by down and play type
nfl_small |>
  group_by(down, play_type) |>
  summarise(
    n = n(),
    mean_yards = mean(yards_gained, na.rm = TRUE),
    median_yards = median(yards_gained, na.rm = TRUE),
    sd_yards = sd(yards_gained, na.rm = TRUE),
    .groups = "drop"
  )
```

This table gives us the summaries for each play type by each down. We can observe how the effectiveness of pass vs. run plays changes depending on the down.

# Visualizations

In this section, we create multiple plots to explore relationships in the data. All plots have clear labels and titles, and we use various techniques including coloring, grouping, and faceting to display multivariate information.

## Plot 1: Bar Chart - Play Type Distribution

This univariate plot shows the overall frequency of different play types in the dataset:

```{r plot1-bar-play-type, fig.width=10, fig.height=6}
nfl_09_18 |>
  count(play_type) |>
  mutate(play_type = fct_reorder(play_type, n)) |>
  ggplot(aes(x = play_type, y = n, fill = play_type)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = scales::comma(n)), hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.1))) +
  scale_fill_viridis_d(option = "plasma") +
  labs(
    title = "Distribution of Play Types in NFL (2009-2018)",
    subtitle = "Pass and run plays dominate game action",
    x = "Play Type",
    y = "Number of Plays",
    caption = "Data: nflfastR"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 14))
```

## Plot 2: Histogram with Density - Yards Gained by Play Type (Multivariate with Faceting)

This plot shows the distribution of yards gained for passing and running plays. Each facet represents a play type, and the histogram bars show play counts, overlaid with a smooth density curve. The dashed red line shows the median yards gained, and the solid blue line shows the mean.

```{r plot2-histogram-density, fig.width=12, fig.height=6}
# Keep run/pass only for this visualization
nfl_runpass <- nfl_09_18 |>
  filter(play_type %in% c("run", "pass"))

# Calculate reference statistics for lines
summ_ref <- nfl_runpass |>
  group_by(play_type) |>
  summarise(
    mean_yards = mean(yards_gained, na.rm = TRUE),
    median_yards = median(yards_gained, na.rm = TRUE)
  )

ggplot(nfl_runpass, aes(x = yards_gained)) +
  geom_histogram(binwidth = 1, fill = "lightgray", boundary = 0, alpha = 0.9) +
  geom_density(aes(y = after_stat(count)), linewidth = 0.6, alpha = 0.6) +
  geom_vline(
    data = summ_ref, 
    aes(xintercept = median_yards), 
    color = "red", 
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    data = summ_ref, 
    aes(xintercept = mean_yards), 
    color = "blue",
    linewidth = 1
  ) +
  facet_wrap(~ play_type, nrow = 1, scales = "free_y") +
  coord_cartesian(xlim = c(-10, 25)) +  
  labs(
    title = "Distribution of Yards Gained by Play Type",
    subtitle = "Blue line = mean | Red dashed line = median",
    x = "Yards Gained",
    y = "Number of Plays",
    caption = "Data: nflfastR | Extreme outliers beyond ±25 yards excluded from view"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 14),
    strip.text = element_text(face = "bold", size = 11)
  )
```

**Key Observations:**

-   **Passing plays** have a much wider spread. Most pass plays gain between 0 and 10 yards, but there are many outliers with 15+ yards gained or negative yardage (sacks, incompletions behind the line of scrimmage).
-   **Running plays** are more tightly clustered. Most runs gain roughly 3–5 yards and there are relatively fewer extreme outcomes.
-   The right-skew in both plots shows that while most plays gain only a few yards, a small number of plays result in long gains.
-   The gap between mean (blue) and median (red) is more pronounced for passes, indicating the influence of extreme values (big gains or sacks).

## Plot 3: Boxplot - Yards Gained by Play Type (Multivariate with Color)

These box plots compare the median and spread of yards gained for run vs. pass plays, highlighting the interquartile range and outliers:

```{r plot3-boxplot-simple, fig.width=10, fig.height=6}
ggplot(nfl_runpass, aes(x = play_type, y = yards_gained, fill = play_type)) +
  geom_boxplot(outlier.alpha = 0.15, width = 0.7) +
  scale_fill_manual(
    values = c("pass" = "#0072B2", "run" = "#D55E00"),
    name = "Play Type"
  ) +
  coord_cartesian(ylim = c(-10, 25)) +
  labs(
    title = "Yards Gained by Play Type",
    subtitle = "Pass plays show higher median but much greater variability",
    x = "Play Type",
    y = "Yards Gained",
    caption = "Data: nflfastR | Outliers beyond ±25 yards excluded from view"
  ) +
  guides(fill = "none") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 14))
```

The boxplot reinforces the histogram findings: passes have a higher median and mean but much greater spread, while runs are more predictable with tighter clustering around the median.

## Plot 4: Stacked Bar Chart - Play Type by Down (Multivariate with Color)

This stacked bar chart shows the proportion of pass vs run plays across different downs:

```{r plot4-stacked-bar, fig.width=10, fig.height=6}
nfl_small |>
  count(down, play_type) |>
  ggplot(aes(x = factor(down), y = n, fill = play_type)) +
  geom_col(position = "fill") +
  scale_fill_manual(
    values = c("pass" = "#0072B2", "run" = "#D55E00"),
    name = "Play Type"
  ) +
  labs(
    title = "Proportion of Pass vs Run Plays by Down",
    subtitle = "Teams pass more frequently on 2nd and 3rd down",
    x = "Down",
    y = "Proportion of Plays",
    caption = "Data: nflfastR | Pass and Run plays only"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom"
  )
```

## Plot 5: Faceted Boxplot - Yards by Down and Play Type (Multivariate with Color and Faceting)

This plot uses both color and faceting to show how yards gained varies by both down and play type:

```{r plot5-facet-boxplot, fig.width=12, fig.height=8}
nfl_small |>
  ggplot(aes(x = factor(down), y = yards_gained, fill = play_type)) +
  geom_boxplot(outlier.alpha = 0.2) +
  facet_wrap(~ play_type, ncol = 2) +
  scale_fill_manual(
    values = c("pass" = "#0072B2", "run" = "#D55E00"),
    name = "Play Type"
  ) +
  coord_cartesian(ylim = c(-10, 25)) +
  labs(
    title = "Yards Gained Across Downs by Play Type",
    subtitle = "Distributions separated by play type and down",
    x = "Down",
    y = "Yards Gained",
    caption = "Data: nflfastR"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 11)
  )
```

## Plot 6: Line Plot - Average Yards by Season and Play Type (Multivariate with Color and Grouping)

This plot shows trends over time, using color and grouping to distinguish play types:

```{r plot6-line-plot, fig.width=10, fig.height=6}
nfl_small %>%
  group_by(season, play_type) %>%
  summarise(
    mean_yards = mean(yards_gained, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = season, y = mean_yards, color = play_type, group = play_type)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(
    values = c("pass" = "#0072B2", "run" = "#D55E00"),
    name = "Play Type"
  ) +
  scale_x_continuous(breaks = 2009:2018) +
  labs(
    title = "Average Yards Gained per Play Over Time",
    subtitle = "Passing and running efficiency trends from 2009-2018",
    x = "Season",
    y = "Average Yards Gained",
    caption = "Data: nflfastR"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
```

## Plot 7: Heatmap - Play Count by Down and Yard Line (Advanced Plot - Not Covered in Class)

This heatmap shows play frequency by field position and down, using a color gradient to represent density. This type of visualization was not covered in class and provides insights into strategic play-calling patterns:

```{r plot7-heatmap, fig.width=12, fig.height=6}
# Create yardline bins
nfl_small_yards <- nfl_small |>
  filter(!is.na(yardline_100)) |>
  mutate(
    yardline_bin = cut(
      yardline_100, 
      breaks = seq(0, 100, by = 10),
      labels = c("0-10", "10-20", "20-30", "30-40", "40-50", 
                 "50-60", "60-70", "70-80", "80-90", "90-100"),
      include.lowest = TRUE
    )
  )

# Create heatmap
nfl_small_yards |>
  count(down, yardline_bin) |>
  ggplot(aes(x = yardline_bin, y = factor(down), fill = n)) +
  geom_tile(color = "white", size = 0.5) +
  geom_text(aes(label = scales::comma(n, accuracy = 1)), 
            color = "white", fontface = "bold", size = 3) +
  scale_fill_viridis_c(
    option = "plasma",
    name = "Number\nof Plays",
    labels = scales::comma
  ) +
  labs(
    title = "Heatmap: Play Frequency by Down and Field Position",
    subtitle = "Yards to opponent's end zone (100 = own goal line, 0 = opponent's goal line)",
    x = "Yards to Opponent's End Zone",
    y = "Down",
    caption = "Data: nflfastR | Darker colors indicate more plays"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right"
  )
```

**Interpretation:** The heatmap reveals that most plays occur in the middle of the field (30-70 yard lines) across all downs. First down has the highest play frequency across all field positions. The pattern shows teams are more conservative near their own goal line and more aggressive in opponent territory.

The following chunks look at the averages for each teams passing/running yards gained over the seasons 2009-2018.

```{r}

# Average yards gained on passing plays by team
team_pass <- nfl_small |>
  filter(play_type == "pass", !is.na(posteam)) |>
  group_by(posteam) |>
  summarise(mean_yards = mean(yards_gained, na.rm = TRUE)) |>
  arrange(mean_yards)

```

```{r fig.width=12, fig.height=10}
ggplot(team_pass, aes(x = mean_yards, y = fct_reorder(posteam, mean_yards))) +
  geom_col(fill = "#0072B2", width = 0.7) +
  geom_text(aes(label = round(mean_yards, 2)), hjust = -0.2, size = 4.5) +
  coord_cartesian(xlim = c(0, max(team_pass$mean_yards) + 1)) +
  labs(
    title = "Average Yards per Pass Play by Team (2009–2018)",
    subtitle = "Teams ranked by average yards gained on passing plays",
    x = "Average Yards Gained (Pass)",
    y = "Team",
    caption = "Data: nflfastR"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_text(size = 14),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12)
  )
```

Looking at the plot we can see that LAC had the highest average of yards_gained via passing over the years 2009-2018 while STL had the lowest.

```{r}
team_run <- nfl_small |>
  filter(play_type == "run", !is.na(posteam)) |>
  group_by(posteam) |>
  summarise(mean_yards = mean(yards_gained, na.rm = TRUE)) |>
  arrange(mean_yards)

```

```{r fig.width=12, fig.height=10}
ggplot(team_run, aes(x = mean_yards, y = fct_reorder(posteam, mean_yards))) +
  geom_col(fill = "#D55E00") +
  geom_text(aes(label = round(mean_yards, 2)), hjust = -0.1, size = 3.5) +
  coord_cartesian(xlim = c(0, max(team_run$mean_yards) + 1)) +
  labs(
    title = "Average Yards per Run Play by Team (2009–2018)",
    subtitle = "Teams ranked by average yards gained on running plays",
    x = "Average Yards Gained (Run)",
    y = "Team",
    caption = "Data: nflfastR"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14)
  )
```

Looking at the above the team that had the highest average yards gained via running over the years 2009-2018 was PHI.

# Key Findings Summary

## Categorical Variables

1.  **Play Type Distribution**: Pass (45%) and run (42%) plays make up the vast majority of all plays
2.  **Down Patterns**:
    -   1st down has the most plays overall
    -   4th down has dramatically fewer plays (teams often punt or attempt field goals)
    -   Run plays decrease as downs progress; pass plays stay relatively consistent

## Numeric Variables

1.  **Yards Gained**:
    -   Pass plays: mean ≈ 6.5 yards, high variability (SD ≈ 13.0)
    -   Run plays: mean ≈ 4.3 yards, lower variability (SD ≈ 6.7)
    -   Pass plays are riskier but potentially more rewarding
    -   Both distributions are right-skewed with long tails
2.  **Temporal Patterns**:
    -   Average yards per play remained relatively stable from 2009-2018
    -   No dramatic changes in offensive strategy over this period
3.  **Strategic Patterns**:
    -   Teams pass more on 2nd and 3rd down
    -   Field position influences play frequency (most plays in mid-field)

# Conclusions

This exploratory analysis reveals several patterns that will be useful for the Shiny app:

## Key Variables Identified

**Categorical variables of interest:** - `play_type` - fundamental to understanding offensive strategy - `down` - critical game situation variable - `season` - allows for year-over-year comparisons

**Numeric variables of interest:** - `yards_gained` - primary outcome measure - `yardline_100` - field position context - `score_differential` - game situation context

## Interesting Relationships to Explore

1.  **Play type effectiveness**: Pass vs run yards gained patterns
2.  **Down and distance**: How game situations affect play calling
3.  **Field position**: How location on field influences strategy
4.  **Temporal trends**: Changes in offensive strategies over seasons

The Shiny app will allow users to filter by these variables and create custom visualizations to explore these patterns in more depth, enabling deeper insights into NFL offensive strategy and play outcomes.
